<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Thu Chi T·ªìn Qu·ªπ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/apexcharts/3.45.1/apexcharts.min.js"></script>
    <style>
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading.hidden {
            display: none;
        }

        .filter-drawer {
            transition: transform 0.3s ease-in-out;
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 50;
            overflow-y: auto;
        }

        @media (min-width: 768px) {
            .filter-drawer {
                width: 400px;
                right: -400px;
            }
        }

        .filter-drawer.open {
            transform: translateX(-100%);
        }

        .filter-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
            z-index: 40;
        }

        .filter-backdrop.show {
            opacity: 1;
            visibility: visible;
        }

        .filter-chip {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            background: #f3f4f6;
            border-radius: 9999px;
            margin: 0.25rem;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .filter-chip:hover {
            background: #e5e7eb;
        }

        .filter-chip.active {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .date-input {
            position: relative;
        }

        .date-input input {
            padding-right: 2.5rem;
        }

        .date-input::after {
            content: "üìÖ";
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }

        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: #94a3b8 #f1f5f9;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #94a3b8;
            border-radius: 20px;
        }

        .table-container {
            overflow-x: auto;
            scrollbar-width: thin;
            scrollbar-color: #94a3b8 #f1f5f9;
        }

        .table-container::-webkit-scrollbar {
            height: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .table-container::-webkit-scrollbar-thumb {
            background-color: #94a3b8;
            border-radius: 20px;
            border: 2px solid #f1f5f9;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
    </style>
</head>

<body class="bg-slate-50">
    <!-- Loading Indicator -->
    <div id="loading" class="loading hidden">
        <div class="flex flex-col items-center">
            <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
            <div class="mt-4 text-lg font-medium text-blue-600">ƒêang t·∫£i d·ªØ li·ªáu...</div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header area with filter button -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-900">Qu·∫£n L√Ω Thu Chi T·ªìn Qu·ªπ</h1>
            <button id="openFilters"
                class="inline-flex items-center px-4 py-2 bg-white border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50">
                <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4">
                    </path>
                </svg>
                B·ªô l·ªçc
            </button>
        </div>

        <!-- Active Filters Display -->
        <div id="activeFilters" class="mb-6 flex flex-wrap gap-2">
            <!-- Active filters will be inserted here -->
        </div>

        <!-- Filter Backdrop -->
        <div id="filterBackdrop" class="filter-backdrop"></div>

        <!-- Filter Drawer -->
        <div id="filterDrawer" class="filter-drawer">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-semibold text-gray-900">B·ªô l·ªçc</h2>
                    <button id="closeFilters" class="text-gray-400 hover:text-gray-500">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="space-y-6">
                    <!-- Th·ªùi gian -->
                    <div class="space-y-4">
                        <label class="block text-sm font-medium text-gray-700">Th·ªùi gian</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="date-input">
                                <input type="date" data-filter="startDate"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div class="date-input">
                                <input type="date" data-filter="endDate"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button class="quick-date filter-chip" data-days="7">7 ng√†y</button>
                            <button class="quick-date filter-chip" data-days="30">30 ng√†y</button>
                            <button class="quick-date filter-chip" data-period="month">Th√°ng n√†y</button>
                            <button class="quick-date filter-chip" data-period="year">NƒÉm n√†y</button>
                        </div>
                    </div>

                    <!-- C√°c b·ªô l·ªçc kh√°c -->
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ph√¢n lo·∫°i</label>
                            <select data-filter="category"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">T·∫•t c·∫£</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nh√≥m</label>
                            <select data-filter="group"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">T·∫•t c·∫£</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ng∆∞·ªùi th·ª±c hi·ªán</label>
                            <select data-filter="person"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">T·∫•t c·∫£</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ngu·ªìn giao d·ªãch</label>
                            <select data-filter="source"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">T·∫•t c·∫£</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="mt-8 space-y-4">
                    <button id="applyFilters"
                        class="w-full px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors">
                        √Åp d·ª•ng b·ªô l·ªçc
                    </button>
                    <button id="resetFilters"
                        class="w-full px-4 py-2 bg-gray-100 text-gray-700 font-medium rounded-lg hover:bg-gray-200 transition-colors">
                        ƒê·∫∑t l·∫°i b·ªô l·ªçc
                    </button>
                </div>
            </div>
        </div>

        <!-- Cards t·ªïng quan -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div
                class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:border-blue-500 transition-colors">
                <h2 class="text-sm font-medium text-slate-600">T·ªïng Thu</h2>
                <p class="text-2xl font-semibold text-green-600 mt-2" data-stat="income">0 ‚Ç´</p>
            </div>
            <div
                class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:border-blue-500 transition-colors">
                <h2 class="text-sm font-medium text-slate-600">T·ªïng Chi</h2>
                <p class="text-2xl font-semibold text-red-600 mt-2" data-stat="expense">0 ‚Ç´</p>
            </div>
            <div
                class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:border-blue-500 transition-colors">
                <h2 class="text-sm font-medium text-slate-600">T·ªìn Qu·ªπ</h2>
                <p class="text-2xl font-semibold text-blue-600 mt-2" data-stat="balance">0 ‚Ç´</p>
            </div>
            <div
                class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:border-blue-500 transition-colors">
                <h2 class="text-sm font-medium text-slate-600">S·ªë Giao D·ªãch</h2>
                <p class="text-2xl font-semibold text-purple-600 mt-2" data-stat="transactions">0</p>
            </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mb-6">
            <h2 class="text-lg font-medium text-slate-800 mb-4">Th·ªëng k√™ Thu Chi T·ªìn Qu·ªπ</h2>
            <div id="weeklyChart" style="width: 100%; height: 400px;"></div>
        </div>

        <!-- B·∫£ng chi ti·∫øt -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-6 border-b border-slate-200 flex flex-wrap justify-between items-center gap-4">
                <h2 class="text-lg font-medium text-slate-800">Chi ti·∫øt thu chi t·ªìn qu·ªπ</h2>
                <button id="printReport"
                    class="px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors">
                    In b√°o c√°o
                </button>
                <button id="exportExcel"
                    class="px-4 py-2 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition-colors">
                    Xu·∫•t Excel
                </button>
            </div>
            <div class="table-container">
                <table class="w-full">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                Ph√¢n lo·∫°i</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                Nh√≥m</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                Ng√†y CT</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                S·ªë CT</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                S·ªë ti·ªÅn</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                Di·ªÖn gi·∫£i</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                Ng∆∞·ªùi chi</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                Ng∆∞·ªùi n·ªôp</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                C√¥ng ty</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                Ngu·ªìn chi</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                Ng∆∞·ªùi nh·∫≠n</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                Ngu·ªìn nh·∫≠n</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                Ghi ch√∫</th>
                        </tr>
                    </thead>
                    <tbody id="transactionTableBody" class="divide-y divide-slate-200">
                        <!-- Data will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const config = {
            appId: 'd9ee17ac-4397-452d-9e74-97997607fa4b',
            accessKey: 'V2-Rovhm-ZiLxx-msd7k-TSoig-NkECL-5LXEq-Kraws-yE09V',
            region: 'www'
        };

        // State management
        let currentData = [];
        let filteredData = [];
        let uniqueValues = {
            categories: new Set(),
            groups: new Set(),
            persons: new Set(),  // Th√™m c√°i n√†y
            sources: new Set(),  // Th√™m c√°i n√†y
        };

        // Loading indicator
        function toggleLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }

        // Filter drawer management
        function toggleFilterDrawer(show) {
            const filterDrawer = document.getElementById('filterDrawer');
            const filterBackdrop = document.getElementById('filterBackdrop');
            filterDrawer.classList.toggle('open', show);
            filterBackdrop.classList.toggle('show', show);
            document.body.style.overflow = show ? 'hidden' : '';
        }

        // Fetch data from API
        async function fetchData() {
            toggleLoading(true);
            const tableName = encodeURIComponent("THU CHI TON QUY");

            try {
                const response = await fetch(
                    `https://api.appsheet.com/api/v2/apps/${config.appId}/tables/${tableName}/Action`,
                    {
                        method: 'POST',
                        headers: {
                            'ApplicationAccessKey': config.accessKey,
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            Action: 'Find',
                            Properties: {},
                            Selector: ''
                        })
                    }
                );

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                currentData = data;
                filteredData = [...currentData];

                populateFilters();
                updateDashboard();
                updateTable();
            } catch (error) {
                console.error('Failed to fetch data:', error);
                alert('L·ªói khi t·∫£i d·ªØ li·ªáu: ' + error.message);
            } finally {
                toggleLoading(false);
            }
        }

        // Populate filter options
        // Populate filter options  
        function populateFilters() {
            // Reset unique values
            Object.keys(uniqueValues).forEach(key => uniqueValues[key].clear());

            // Collect unique values from data  
            currentData.forEach(item => {
                if (item['Ph√¢n lo·∫°i']) uniqueValues.categories.add(item['Ph√¢n lo·∫°i']);
                if (item['Nh√≥m thu chi']) uniqueValues.groups.add(item['Nh√≥m thu chi']);

                // G·ªôp ng∆∞·ªùi chi v√† ng∆∞·ªùi nh·∫≠n
                if (item['Ng∆∞·ªùi chi']) uniqueValues.persons.add(item['Ng∆∞·ªùi chi']);
                if (item['Ng∆∞·ªùi nh·∫≠n']) uniqueValues.persons.add(item['Ng∆∞·ªùi nh·∫≠n']);

                // G·ªôp ngu·ªìn chi v√† ngu·ªìn nh·∫≠n
                if (item['Ngu·ªìn chi (TM/ S·ªë TK)']) uniqueValues.sources.add(item['Ngu·ªìn chi (TM/ S·ªë TK)']);
                if (item['Ngu·ªìn nh·∫≠n (TM/ S·ªë TK)']) uniqueValues.sources.add(item['Ngu·ªìn nh·∫≠n (TM/ S·ªë TK)']);
            });

            // Update select elements
            updateSelect('category', uniqueValues.categories);
            updateSelect('group', uniqueValues.groups);
            updateSelect('person', uniqueValues.persons);
            updateSelect('source', uniqueValues.sources);
        }

        // Update select element options
        function updateSelect(filterName, values) {
            const select = document.querySelector(`[data-filter="${filterName}"]`);
            const currentValue = select.value;
            select.innerHTML = '<option value="">T·∫•t c·∫£</option>' +
                Array.from(values)
                    .filter(Boolean)
                    .sort((a, b) => a.localeCompare(b, 'vi'))
                    .map(value => `<option value="${value}">${value}</option>`)
                    .join('');
            select.value = currentValue;
        }

        // Apply filters
        function applyFilters() {
            const filters = {
                startDate: document.querySelector('[data-filter="startDate"]').value,
                endDate: document.querySelector('[data-filter="endDate"]').value,
                category: document.querySelector('[data-filter="category"]').value,
                group: document.querySelector('[data-filter="group"]').value,
                person: document.querySelector('[data-filter="person"]').value,
                source: document.querySelector('[data-filter="source"]').value
            };

            filteredData = currentData.filter(item => {
                const itemDate = new Date(item['Ng√†y ch·ª©ng t·ª´']);

                if (filters.startDate) {
                    const startDate = new Date(filters.startDate);
                    startDate.setHours(0, 0, 0, 0);
                    if (itemDate < startDate) return false;
                }

                if (filters.endDate) {
                    const endDate = new Date(filters.endDate);
                    endDate.setHours(23, 59, 59, 999);
                    if (itemDate > endDate) return false;
                }

                if (filters.category && item['Ph√¢n lo·∫°i'] !== filters.category) return false;
                if (filters.group && item['Nh√≥m thu chi'] !== filters.group) return false;

                // Ki·ªÉm tra ng∆∞·ªùi th·ª±c hi·ªán (c·∫£ chi v√† nh·∫≠n)
                if (filters.person && item['Ng∆∞·ªùi chi'] !== filters.person && item['Ng∆∞·ªùi nh·∫≠n'] !== filters.person) return false;

                // Ki·ªÉm tra ngu·ªìn giao d·ªãch (c·∫£ chi v√† nh·∫≠n) 
                if (filters.source && item['Ngu·ªìn chi (TM/ S·ªë TK)'] !== filters.source && item['Ngu·ªìn nh·∫≠n (TM/ S·ªë TK)'] !== filters.source) return false;

                return true;
            });

            updateActiveFilters();
            updateDashboard();
            updateTable();
            toggleFilterDrawer(false);
        }

        // Update active filters display
        function updateActiveFilters() {
            const activeFiltersContainer = document.getElementById('activeFilters');
            activeFiltersContainer.innerHTML = '';

            const filters = {
                'Ph√¢n lo·∫°i': document.querySelector('[data-filter="category"]').value,
                'Nh√≥m': document.querySelector('[data-filter="group"]').value,
                'Ng∆∞·ªùi th·ª±c hi·ªán': document.querySelector('[data-filter="person"]').value,
                'Ngu·ªìn giao d·ªãch': document.querySelector('[data-filter="source"]').value
            };

            for (const [key, value] of Object.entries(filters)) {
                if (value) {
                    const chip = document.createElement('div');
                    chip.className = 'filter-chip active';
                    chip.innerHTML = `
                        ${key}: ${value}
                        <button class="ml-2 text-gray-500 hover:text-gray-700" data-remove="${key.toLowerCase()}">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    `;
                    activeFiltersContainer.appendChild(chip);
                }
            }

            // Add event listeners for remove buttons
            document.querySelectorAll('[data-remove]').forEach(button => {
                button.addEventListener('click', (e) => {
                    const filterKey = e.currentTarget.dataset.remove;
                    const filterMap = {
                        'ph√¢n lo·∫°i': 'category',
                        'nh√≥m': 'group',
                        'ng∆∞·ªùi th·ª±c hi·ªán': 'person',
                        'ngu·ªìn giao d·ªãch': 'source'
                    };

                    document.querySelector(`[data-filter="${filterMap[filterKey]}"]`).value = '';
                    applyFilters();
                });
            });
        }

        // Add print styles to head
        const printStyles = `
@media print {
    /* Hide everything except print content */
    body > *:not(.print-content) {
        display: none !important;
    }
    
    /* Print styling */
    .print-content {
        display: block !important;
        padding: 20px;
        font-family: 'Times New Roman', Times, serif;
    }

    .print-header {
        text-align: center;
        margin-bottom: 20px;
    }

    .print-header h1,
    .print-header h2 {
        margin: 0;
        font-size: 16px;
        font-weight: bold;
    }

    .print-table {
        width: 100%;
        border-collapse: collapse;
        margin: 15px 0;
    }

    .print-table th,
    .print-table td {
        border: 1px solid black;
        padding: 5px;
        text-align: left;
    }

    .print-table th {
        background-color: #f0f0f0;
    }

    /* Page break settings */
    .page-break {
        page-break-before: always;
    }

    /* Remove background colors and ensure black text */
    * {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
        color-adjust: exact;
        background: transparent !important;
        color: black !important;
        box-shadow: none !important;
    }
}
`;

        // Th√™m h√†m t√≠nh s·ªë d∆∞
        function calculateBalance(data) {
            let balance = 0;
            data.forEach(item => {
                const amount = parseFloat(String(item['S·ªë ti·ªÅn']).replace(/[^\d.-]/g, '')) || 0;
                if (item['Ph√¢n lo·∫°i']?.toLowerCase() === 'thu') {
                    balance += amount;
                } else if (item['Ph√¢n lo·∫°i']?.toLowerCase() === 'chi') {
                    balance -= amount;
                }
            });
            return balance;
        }

        function printReport() {
            // Get all data sorted by date
            const allData = currentData.sort((a, b) =>
                new Date(a['Ng√†y ch·ª©ng t·ª´']) - new Date(b['Ng√†y ch·ª©ng t·ª´'])
            );

            // Get filtered data date range
            const startDate = document.querySelector('[data-filter="startDate"]').value;
            const endDate = document.querySelector('[data-filter="endDate"]').value;

            // Calculate opening balance (all transactions before start date)
            const previousTransactions = allData.filter(item =>
                new Date(item['Ng√†y ch·ª©ng t·ª´']) < new Date(startDate)
            );
            const openingBalance = calculateBalance(previousTransactions);

            // Calculate current period transactions
            const currentTransactions = filteredData;
            const stats = {
                openingBalance: openingBalance,
                income: 0,
                expense: 0
            };

            currentTransactions.forEach(item => {
                const amount = parseFloat(String(item['S·ªë ti·ªÅn']).replace(/[^\d.-]/g, '')) || 0;
                if (item['Ph√¢n lo·∫°i']?.toLowerCase() === 'thu') {
                    stats.income += amount;
                } else if (item['Ph√¢n lo·∫°i']?.toLowerCase() === 'chi') {
                    stats.expense += amount;
                }
            });

            stats.closingBalance = stats.openingBalance + stats.income - stats.expense;

            // Separate transactions
            const incomeTransactions = filteredData.filter(item =>
                item['Ph√¢n lo·∫°i']?.toLowerCase() === 'thu');
            const expenseTransactions = filteredData.filter(item =>
                item['Ph√¢n lo·∫°i']?.toLowerCase() === 'chi');

            const printContent = `
        <style>
            @media print {
                @page { 
                    size: A4;
                    margin: 20mm 15mm;
                }
                .print-content {
                    font-family: 'Times New Roman', Times, serif;
                    font-size: 13px;
                }
                .print-header {
                    text-align: center;
                    margin-bottom: 20px;
                }
                .print-table {
                    width: 100%;
                    border-collapse: collapse;
                    margin: 15px 0;
                }
                .print-table th,
                .print-table td {
                    border: 1px solid black;
                    padding: 5px;
                    text-align: left;
                }
                .total-row td {
                    font-weight: bold;
                }
                .page-break {
                    page-break-before: always;
                }
            }
        </style>
        <div class="print-content">
            <div class="print-header">
                <h1 style="margin: 0; font-size: 16px;">CLB PICKLEBALL DOANH NH√ÇN TR·∫∫ B√åNH D∆Ø∆†NG</h1>
                <p style="margin: 5px 0;">45B, Yersin, Ph√∫ C∆∞·ªùng, Th·ªß D·∫ßu M·ªôt, B√¨nh D∆∞∆°ng</p>
                <h2 style="margin: 20px 0; font-size: 16px;">S·ªî B√ÅO C√ÅO THU - CHI</h2>
                <p style="margin: 5px 0;">T·ª´ ng√†y: ${formatDate(startDate)} ƒê·∫øn ng√†y ${formatDate(endDate)}</p>
            </div>
            
            <p>K√≠nh g·ª≠i: Ban Ch·∫•p H√†nh CLB PICKLEBALL Doanh Nh√¢n tr·∫ª B√¨nh D∆∞∆°ng</p>

            <table class="print-table">
                <tr>
                    <th></th>
                    <th>T·ªìn ƒë·∫ßu</th>
                    <th>Thu</th>
                    <th>Chi</th>
                    <th>T·ªìn cu·ªëi</th>
                </tr>
                <tr>
                    <td>Ng√¢n h√†ng TPBank<br/>(20022000000 ƒêo√†n Th·ªã Qu·ª≥nh Nga)</td>
                    <td>${formatCurrency(stats.openingBalance)}</td>
                    <td>${formatCurrency(stats.income)}</td>
                    <td>${formatCurrency(stats.expense)}</td>
                    <td>${formatCurrency(stats.closingBalance)}</td>
                </tr>
            </table>

            <div style="margin-top: 30px;">
                <h3>B√ÅO C√ÅO THU</h3>
                <table class="print-table">
                    <tr>
                        <th>STT</th>
                        <th>Ng√†y</th>
                        <th>S·ªë ch·ª©ng t·ª´</th>
                        <th>Nh√≥m thu</th>
                        <th>S·ªë ti·ªÅn</th>
                        <th>Di·ªÖn gi·∫£i</th>
                        <th>Ng∆∞·ªùi n·ªôp ti·ªÅn</th>
                        <th>Ngu·ªìn chi (TK)</th>
                        <th>Ng∆∞·ªùi nh·∫≠n</th>
                        <th>Ngu·ªìn nh·∫≠n (TK)</th>
                    </tr>
                    ${incomeTransactions.map((item, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${formatDate(item['Ng√†y ch·ª©ng t·ª´'])}</td>
                            <td>${item['S·ªë ch·ª©ng t·ª´'] || ''}</td>
                            <td>${item['Nh√≥m thu chi'] || ''}</td>
                            <td>${formatCurrency(item['S·ªë ti·ªÅn'])}</td>
                            <td>${item['Di·ªÉn gi·∫£i'] || ''}</td>
                            <td>${item['Ng∆∞·ªùi n·ªôp ti·ªÅn'] || ''}</td>
                            <td>${item['Ngu·ªìn chi (TM/ S·ªë TK)'] || ''}</td>
                            <td>${item['Ng∆∞·ªùi nh·∫≠n'] || ''}</td>
                            <td>${item['Ngu·ªìn nh·∫≠n (TM/ S·ªë TK)'] || ''}</td>
                        </tr>
                    `).join('')}
                    <tr class="total-row">
                        <td colspan="4" style="text-align: right;">T·ªïng thu:</td>
                        <td colspan="6">${formatCurrency(stats.income)}</td>
                    </tr>
                </table>
            </div>

            <div class="page-break">
                <h3>B√ÅO C√ÅO CHI</h3>
                <table class="print-table">
                    <tr>
                        <th>STT</th>
                        <th>Ng√†y</th>
                        <th>S·ªë ch·ª©ng t·ª´</th>
                        <th>Nh√≥m chi</th>
                        <th>S·ªë ti·ªÅn</th>
                        <th>Di·ªÖn gi·∫£i</th>
                        <th>Ng∆∞·ªùi chi</th>
                        <th>Ngu·ªìn chi (TK)</th>
                        <th>Ng∆∞·ªùi nh·∫≠n</th>
                        <th>Ngu·ªìn nh·∫≠n (TK)</th>
                    </tr>
                    ${expenseTransactions.map((item, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${formatDate(item['Ng√†y ch·ª©ng t·ª´'])}</td>
                            <td>${item['S·ªë ch·ª©ng t·ª´'] || ''}</td>
                            <td>${item['Nh√≥m thu chi'] || ''}</td>
                            <td>${formatCurrency(item['S·ªë ti·ªÅn'])}</td>
                            <td>${item['Di·ªÉn gi·∫£i'] || ''}</td>
                            <td>${item['Ng∆∞·ªùi chi'] || ''}</td>
                            <td>${item['Ngu·ªìn chi (TM/ S·ªë TK)'] || ''}</td>
                            <td>${item['Ng∆∞·ªùi nh·∫≠n'] || ''}</td>
                            <td>${item['Ngu·ªìn nh·∫≠n (TM/ S·ªë TK)'] || ''}</td>
                        </tr>
                    `).join('')}
                    <tr class="total-row">
                        <td colspan="4" style="text-align: right;">T·ªïng chi:</td>
                        <td colspan="6">${formatCurrency(stats.expense)}</td>
                    </tr>
                </table>
            </div>
        </div>
    `;

            // Create print window
            const printWindow = window.open('', '', 'width=1000,height=600');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();

            // Print after images are loaded
            printWindow.onload = function () {
                printWindow.print();
                printWindow.close();
            };
        }

        
        // Reset all filters
        function resetFilters() {
            // Reset t·∫•t c·∫£ c√°c filter v·ªÅ gi√° tr·ªã m·∫∑c ƒë·ªãnh
            document.querySelectorAll('[data-filter]').forEach(filter => {
                filter.value = '';
            });

            document.querySelectorAll('.quick-date').forEach(btn =>
                btn.classList.remove('active'));

            // Reset date range v·ªÅ m·∫∑c ƒë·ªãnh (ƒë·∫ßu th√°ng ƒë·∫øn hi·ªán t·∫°i)
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);

            document.querySelector('[data-filter="startDate"]').value =
                firstDayOfMonth.toISOString().split('T')[0];
            document.querySelector('[data-filter="endDate"]').value =
                today.toISOString().split('T')[0];

            // Reset l·∫°i data
            filteredData = [...currentData];

            // C·∫≠p nh·∫≠t UI
            updateActiveFilters();

            // Log ƒë·ªÉ debug
            console.log('After Reset - Filtered Data Length:', filteredData.length);
            console.log('Sample Data:', filteredData.slice(0, 2));

            // C·∫≠p nh·∫≠t dashboard v√† table
            updateDashboard();
            updateTable();

            // T·∫£i l·∫°i d·ªØ li·ªáu t·ª´ API
            fetchData();
        }

        // Th√™m h√†m n√†y v√†o ph·∫ßn JavaScript hi·ªán c√≥
        function updateWeeklyChart() {
            const weeklyData = {};

            // X·ª≠ l√Ω d·ªØ li·ªáu theo tu·∫ßn
            filteredData.forEach(item => {
                const date = new Date(item['Ng√†y ch·ª©ng t·ª´']);
                const weekKey = getWeekKey(date);

                if (!weeklyData[weekKey]) {
                    weeklyData[weekKey] = {
                        thu: 0,
                        chi: 0,
                        tonQuy: 0
                    };
                }

                const amount = parseFloat(String(item['S·ªë ti·ªÅn']).replace(/[^\d.-]/g, '')) || 0;
                if (item['Ph√¢n lo·∫°i']?.toLowerCase() === 'thu') {
                    weeklyData[weekKey].thu += amount;
                } else if (item['Ph√¢n lo·∫°i']?.toLowerCase() === 'chi') {
                    weeklyData[weekKey].chi += amount;
                }
            });

            // T√≠nh t·ªìn qu·ªπ t√≠ch l≈©y
            let accumulatedBalance = 0;
            Object.keys(weeklyData).sort().forEach(week => {
                accumulatedBalance += weeklyData[week].thu - weeklyData[week].chi;
                weeklyData[week].tonQuy = accumulatedBalance;
            });

            // Chu·∫©n b·ªã d·ªØ li·ªáu cho bi·ªÉu ƒë·ªì
            const weeks = Object.keys(weeklyData).sort().slice(-8); // L·∫•y 8 tu·∫ßn g·∫ßn nh·∫•t
            const thu = weeks.map(week => weeklyData[week].thu);
            const chi = weeks.map(week => weeklyData[week].chi);
            const tonQuy = weeks.map(week => weeklyData[week].tonQuy);

            // C·∫•u h√¨nh bi·ªÉu ƒë·ªì
            const options = {
                series: [
                    {
                        name: 'Thu',
                        type: 'column',
                        data: thu
                    },
                    {
                        name: 'Chi',
                        type: 'column',
                        data: chi
                    },
                    {
                        name: 'T·ªìn Qu·ªπ',
                        type: 'line',
                        data: tonQuy
                    }
                ],
                chart: {
                    height: 400,
                    type: 'line',
                    stacked: false,
                    toolbar: {
                        show: true
                    }
                },
                stroke: {
                    width: [1, 1, 4],
                    curve: 'smooth'
                },
                plotOptions: {
                    bar: {
                        columnWidth: '50%'
                    }
                },
                colors: ['#22c55e', '#ef4444', '#3b82f6'],
                xaxis: {
                    categories: weeks.map(formatWeekLabel),
                    labels: {
                        rotate: -45,
                        style: {
                            fontSize: '12px'
                        }
                    }
                },
                yaxis: [
                    {
                        title: {
                            text: 'Thu/Chi (VNƒê)',
                            style: {
                                fontSize: '12px'
                            }
                        },
                        labels: {
                            formatter: function (value) {
                                return formatShortMoney(value);
                            }
                        }
                    }
                ],
                tooltip: {
                    y: {
                        formatter: function (value) {
                            return formatCurrency(value);
                        }
                    }
                },
                legend: {
                    position: 'top',
                    horizontalAlign: 'center'
                }
            };

            // X√≥a bi·ªÉu ƒë·ªì c≈© n·∫øu c√≥
            document.getElementById('weeklyChart').innerHTML = '';

            // Kh·ªüi t·∫°o bi·ªÉu ƒë·ªì m·ªõi
            const chart = new ApexCharts(document.getElementById('weeklyChart'), options);
            chart.render();
        }

        // Th√™m c√°c h√†m ti·ªán √≠ch
        function getWeekKey(date) {
            const firstDayOfWeek = new Date(date.setDate(date.getDate() - date.getDay()));
            return firstDayOfWeek.toISOString().split('T')[0];
        }

        function formatWeekLabel(weekKey) {
            const date = new Date(weekKey);
            return `Tu·∫ßn ${getWeekNumber(date)}`;
        }

        function getWeekNumber(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }

        function formatShortMoney(value) {
            if (Math.abs(value) >= 1000000000) {
                return (value / 1000000000).toFixed(1) + ' t·ª∑';
            } else if (Math.abs(value) >= 1000000) {
                return (value / 1000000).toFixed(1) + ' tr';
            }
            return value.toFixed(0);
        }

        // Update dashboard statistics
        function updateDashboard() {
            const stats = {
                totalIncome: 0,
                totalExpense: 0,
                totalTransactions: filteredData.length
            };

            filteredData.forEach(item => {
                const amount = parseFloat(String(item['S·ªë ti·ªÅn']).replace(/[^\d.-]/g, '')) || 0;
                const category = String(item['Ph√¢n lo·∫°i'] || '').toLowerCase();

                if (category === 'chi') {
                    stats.totalExpense += amount;
                } else if (category === 'thu') {
                    stats.totalIncome += amount;
                }
            });

            stats.balance = stats.totalIncome - stats.totalExpense;

            // C·∫≠p nh·∫≠t UI tr·ª±c ti·∫øp
            document.querySelector('[data-stat="income"]').textContent = formatCurrency(stats.totalIncome);
            document.querySelector('[data-stat="expense"]').textContent = formatCurrency(stats.totalExpense);
            document.querySelector('[data-stat="balance"]').textContent = formatCurrency(stats.balance);
            document.querySelector('[data-stat="transactions"]').textContent = stats.totalTransactions;

            updateWeeklyChart();
        }

        // Animate value changes
        function animateValue(selector, endValue) {
            const element = document.querySelector(selector);
            const startValue = parseFloat(element.textContent.replace(/[^\d.-]/g, '')) || 0;
            const duration = 1000;
            const steps = 60;
            const increment = (endValue - startValue) / steps;

            let currentValue = startValue;
            const update = setInterval(() => {
                currentValue += increment;
                if ((increment > 0 && currentValue >= endValue) ||
                    (increment < 0 && currentValue <= endValue)) {
                    clearInterval(update);
                    currentValue = endValue;
                }
                element.textContent = formatCurrency(currentValue);
            }, duration / steps);
        }

        // Update transaction table
        function updateTable() {
            const tbody = document.getElementById('transactionTableBody');

            const sortedData = [...filteredData].sort((a, b) =>
                new Date(b['Ng√†y ch·ª©ng t·ª´']) - new Date(a['Ng√†y ch·ª©ng t·ª´'])
            );

            tbody.innerHTML = sortedData.map(item => `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900">
                        ${item['Ph√¢n lo·∫°i'] || ''}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900">
                        ${item['Nh√≥m thu chi'] || ''}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900">
                        ${formatDate(item['Ng√†y ch·ª©ng t·ª´'])}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900">
                        ${item['S·ªë ch·ª©ng t·ª´'] || ''}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${item['Ph√¢n lo·∫°i']?.toLowerCase() === 'thu' ? 'text-green-600' : 'text-red-600'}">
                        ${formatCurrency(item['S·ªë ti·ªÅn'])}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900">
                        ${item['Di·ªÉn gi·∫£i'] || ''}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900">
                        ${item['Ng∆∞·ªùi chi'] || '-'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900">
                        ${item['Ng∆∞·ªùi n·ªôp ti·ªÅn'] || '-'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900">
                        ${item['T√™n c√¥ng ty'] || ''}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900">
                        ${item['Ngu·ªìn chi (TM/ S·ªë TK)'] || '-'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900">
                        ${item['Ng∆∞·ªùi nh·∫≠n'] || '-'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900">
                        ${item['Ngu·ªìn nh·∫≠n (TM/ S·ªë TK)'] || '-'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900">
                        ${item['Ghi ch√∫'] || ''}
                    </td>
                </tr>
            `).join('');
        }

        // Export to Excel
        async function exportToExcel() {
            toggleLoading(true);
            try {
                const wb = XLSX.utils.book_new();
                const wsData = filteredData.map(item => ({
                    'Ph√¢n lo·∫°i': item['Ph√¢n lo·∫°i'] || '',
                    'Nh√≥m thu chi': item['Nh√≥m thu chi'] || '',
                    'Ng√†y ch·ª©ng t·ª´': formatDate(item['Ng√†y ch·ª©ng t·ª´']),
                    'S·ªë ch·ª©ng t·ª´': item['S·ªë ch·ª©ng t·ª´'] || '',
                    'S·ªë ti·ªÅn': parseFloat(item['S·ªë ti·ªÅn']) || 0,
                    'Di·ªÖn gi·∫£i': item['Di·ªÉn gi·∫£i'] || '',
                    'Ng∆∞·ªùi chi': item['Ng∆∞·ªùi chi'] || '',
                    'Ng∆∞·ªùi n·ªôp ti·ªÅn': item['Ng∆∞·ªùi n·ªôp ti·ªÅn'] || '',
                    'T√™n c√¥ng ty': item['T√™n c√¥ng ty'] || '',
                    'Ngu·ªìn chi': item['Ngu·ªìn chi (TM/ S·ªë TK)'] || '',
                    'Ng∆∞·ªùi nh·∫≠n': item['Ng∆∞·ªùi nh·∫≠n'] || '',
                    'Ngu·ªìn nh·∫≠n': item['Ngu·ªìn nh·∫≠n (TM/ S·ªë TK)'] || '',
                    'Ghi ch√∫': item['Ghi ch√∫'] || ''
                }));

                const ws = XLSX.utils.json_to_sheet(wsData);
                XLSX.utils.book_append_sheet(wb, ws, "Thu Chi T·ªìn Qu·ªπ");
                XLSX.writeFile(wb, `Bao_cao_thu_chi_ton_quy_${formatDate(new Date())}.xlsx`);
            } catch (error) {
                console.error('Export error:', error);
                alert('L·ªói khi xu·∫•t b√°o c√°o: ' + error.message);
            } finally {
                toggleLoading(false);
            }
        }

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
                maximumFractionDigits: 0
            }).format(amount || 0);
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize filter drawer controls
            const openFiltersBtn = document.getElementById('openFilters');
            const closeFiltersBtn = document.getElementById('closeFilters');
            const filterBackdrop = document.getElementById('filterBackdrop');

            openFiltersBtn.addEventListener('click', () => toggleFilterDrawer(true));
            closeFiltersBtn.addEventListener('click', () => toggleFilterDrawer(false));
            filterBackdrop.addEventListener('click', () => toggleFilterDrawer(false));

            // Initialize quick date filters
            document.querySelectorAll('.quick-date').forEach(button => {
                button.addEventListener('click', (e) => {
                    document.querySelectorAll('.quick-date').forEach(btn =>
                        btn.classList.remove('active'));
                    e.target.classList.add('active');

                    const days = e.target.dataset.days;
                    const period = e.target.dataset.period;
                    const endDate = new Date();
                    let startDate = new Date();

                    if (days) {
                        startDate.setDate(startDate.getDate() - parseInt(days));
                    } else if (period === 'month') {
                        startDate = new Date(endDate.getFullYear(), endDate.getMonth(), 1);
                    } else if (period === 'year') {
                        startDate = new Date(endDate.getFullYear(), 0, 1);
                    }

                    document.querySelector('[data-filter="startDate"]').value =
                        startDate.toISOString().split('T')[0];
                    document.querySelector('[data-filter="endDate"]').value =
                        endDate.toISOString().split('T')[0];

                    applyFilters();
                });
            });

            // Initialize filter buttons
            document.getElementById('applyFilters').addEventListener('click', applyFilters);
            document.getElementById('resetFilters').addEventListener('click', resetFilters);
            document.getElementById('exportExcel').addEventListener('click', exportToExcel);
            document.getElementById('printReport').addEventListener('click', printReport);

            // Load XLSX library
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
            script.onload = () => console.log('XLSX library loaded successfully');
            script.onerror = () => {
                console.error('Failed to load XLSX library');
                alert('Kh√¥ng th·ªÉ t·∫£i th∆∞ vi·ªán xu·∫•t Excel. Vui l√≤ng th·ª≠ l·∫°i sau.');
            };
            document.head.appendChild(script);

            // Set default date range
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            document.querySelector('[data-filter="startDate"]').value =
                firstDayOfMonth.toISOString().split('T')[0];
            document.querySelector('[data-filter="endDate"]').value =
                today.toISOString().split('T')[0];

            // Initialize table scrolling
            const tableContainer = document.querySelector('.table-container');
            if (tableContainer) {
                let isScrolling = false;
                let startX;
                let scrollLeft;

                tableContainer.addEventListener('mousedown', (e) => {
                    isScrolling = true;
                    startX = e.pageX - tableContainer.offsetLeft;
                    scrollLeft = tableContainer.scrollLeft;
                });

                tableContainer.addEventListener('mouseleave', () => {
                    isScrolling = false;
                });

                tableContainer.addEventListener('mouseup', () => {
                    isScrolling = false;
                });

                tableContainer.addEventListener('mousemove', (e) => {
                    if (!isScrolling) return;
                    e.preventDefault();
                    const x = e.pageX - tableContainer.offsetLeft;
                    const walk = (x - startX) * 2;
                    tableContainer.scrollLeft = scrollLeft - walk;
                });
            }

            // Handle network status
            window.addEventListener('online', () => {
                console.log('Back online, refreshing data...');
                fetchData();
            });

            window.addEventListener('offline', () => {
                console.log('Connection lost');
                alert('M·∫•t k·∫øt n·ªëi m·∫°ng. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi internet c·ªßa b·∫°n.');
            });

            // Initial data load
            fetchData();
        });
    </script>
</body>

</html>