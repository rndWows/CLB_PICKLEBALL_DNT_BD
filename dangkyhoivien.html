<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng ký hội viên CLB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/luxon/3.4.4/luxon.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .input-icon {
            position: absolute;
            top: 70%;
            left: 10px;
            transform: translateY(-50%);
            color: #6B7280;
            pointer-events: none;
        }

        .input-with-icon {
            padding-left: 40px;
            border: 2px solid #E5E7EB;
            border-radius: 0.75rem;
            transition: all 0.3s ease;
            background-color: #F9FAFB;
        }

        .input-with-icon:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            background-color: white;
        }

        .fixed-button {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 40px);
            max-width: 600px;
            z-index: 1000;
        }

        .form-container {
            padding-bottom: 100px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }

        .custom-file-input::-webkit-file-upload-button {
            visibility: hidden;
        }

        .custom-file-input::before {
            content: 'Chọn file';
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 0.5rem;
            padding: 8px 16px;
            outline: none;
            white-space: nowrap;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .custom-file-input:hover::before {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: scale(1.05);
        }

        .required-field::after {
            content: ' *';
            color: #EF4444;
            font-weight: bold;
        }

        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2rem;
            border-radius: 1rem 1rem 0 0;
            margin: -2rem -2rem 2rem -2rem;
        }

        .submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }

        .submit-btn:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .image-preview-container {
            position: relative;
            display: inline-block;
        }

        .image-preview-container img {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .image-preview-container img:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
        }

        /* Style cho Choices.js */
        .choices__inner {
            background-color: #F9FAFB !important;
            border: 2px solid #E5E7EB !important;
            border-radius: 0.75rem !important;
            min-height: 48px !important;
            padding-left: 40px !important;
            transition: all 0.3s ease !important;
        }

        .choices__inner:focus,
        .choices.is-focused .choices__inner {
            border-color: #667eea !important;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1) !important;
            background-color: white !important;
        }

        .choices__list--dropdown {
            border: 2px solid #667eea !important;
            border-radius: 0.5rem !important;
            margin-top: 4px !important;
        }

        .choices__item--selectable {
            padding: 12px 16px !important;
        }

        .choices__item--selectable.is-highlighted {
            background-color: #667eea !important;
        }

        /* Style cho Radio Button */
        .radio-container {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 12px 20px;
            border: 2px solid #E5E7EB;
            border-radius: 0.75rem;
            background-color: #F9FAFB;
            transition: all 0.3s ease;
            flex: 1;
        }

        .radio-option:hover {
            border-color: #667eea;
            background-color: white;
        }

        .radio-option input[type="radio"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .radio-option.selected {
            border-color: #667eea;
            background-color: #EEF2FF;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .radio-option label {
            cursor: pointer;
            font-weight: 500;
            color: #374151;
            user-select: none;
        }
    </style>
</head>

<body class="bg-gray-100">
    <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden p-8 mt-10 mb-20 fade-in">
        <div class="card-header">
            <h2 class="text-3xl font-bold text-center text-white">Đăng ký hội viên CLB PICKLEBALL</h2>
            <p class="text-center text-white text-sm mt-2 opacity-90">Vui lòng điền đầy đủ thông tin bên dưới</p>
        </div>

        <form id="expenseForm" class="space-y-6 form-container">
            <!-- Họ và tên -->
            <div class="relative">
                <i data-lucide="user" class="input-icon"></i>
                <label for="hoVaTen" class="block text-sm font-semibold text-gray-700 mb-2 required-field">Họ và tên (Viết in hoa)</label>
                <input type="text" id="hoVaTen" name="hoVaTen"
                    class="input-with-icon mt-1 block w-full shadow-sm h-12 py-2"
                    placeholder="VD: NGUYỄN VĂN A"
                    required>
            </div>

            <!-- Hình hội viên -->
            <div class="relative">
                <label for="fileHS" class="block text-sm font-semibold text-gray-700 mb-2 required-field">Hình hội viên</label>
                <input type="file" id="fileHS" name="fileHS" accept="image/*"
                    class="custom-file-input mt-1 block w-full text-sm text-gray-500"
                    required>
                <div id="imagePreview" class="mt-4 text-center">
                    <!-- Khu vực hiển thị xem trước ảnh -->
                </div>
            </div>

            <!-- Số điện thoại -->
            <div class="relative">
                <i data-lucide="phone" class="input-icon"></i>
                <label for="soDienThoai" class="block text-sm font-semibold text-gray-700 mb-2 required-field">Số điện thoại</label>
                <input type="tel" id="soDienThoai" name="soDienThoai"
                    class="input-with-icon mt-1 block w-full shadow-sm h-12 py-2"
                    placeholder="VD: 0912345678"
                    required>
            </div>

            <!-- Email -->
            <div class="relative">
                <i data-lucide="mail" class="input-icon"></i>
                <label for="email" class="block text-sm font-semibold text-gray-700 mb-2 required-field">Email</label>
                <input type="email" id="email" name="email"
                    class="input-with-icon mt-1 block w-full shadow-sm h-12 py-2"
                    placeholder="VD: example@email.com"
                    required>
            </div>

            <!-- Ngày sinh -->
            <div class="relative">
                <i data-lucide="calendar" class="input-icon"></i>
                <label for="ngaySinh" class="block text-sm font-semibold text-gray-700 mb-2">Ngày sinh</label>
                <input type="date" id="ngaySinh" name="ngaySinh"
                    class="input-with-icon mt-1 block w-full shadow-sm h-12 py-2">
            </div>

            <!-- Giới tính -->
            <div class="relative">
                <i data-lucide="users" class="input-icon"></i>
                <label for="gioiTinh" class="block text-sm font-semibold text-gray-700 mb-2">Giới tính</label>
                <select id="gioiTinh" name="gioiTinh"
                    class="input-with-icon mt-1 block w-full shadow-sm h-12 py-2">
                    <option value="">Chọn giới tính</option>
                    <option value="Nam">Nam</option>
                    <option value="Nữ">Nữ</option>
                    <option value="Khác">Khác</option>
                </select>
            </div>

            <!-- Nơi ở hiện tại -->
            <div class="relative">
                <i data-lucide="map-pin" class="input-icon"></i>
                <label for="diaChi" class="block text-sm font-semibold text-gray-700 mb-2">Nơi ở hiện tại</label>
                <textarea id="diaChi" name="diaChi" rows="3"
                    class="input-with-icon mt-1 block w-full shadow-sm py-2"
                    placeholder="Nhập địa chỉ hiện tại của bạn"></textarea>
            </div>

            <!-- Trình PKB -->
            <div class="relative">
                <i data-lucide="trophy" class="input-icon"></i>
                <label for="trinhPKB" class="block text-sm font-semibold text-gray-700 mb-2">Trình độ Pickleball</label>
                <input type="number" id="trinhPKB" name="trinhPKB" 
                    min="1" max="10" step="0.5"
                    class="input-with-icon mt-1 block w-full shadow-sm h-12 py-2"
                    placeholder="VD: 3.5, 4.0, 5.0...">
            </div>

            <!-- Size áo -->
            <div class="relative">
                <i data-lucide="shirt" class="input-icon"></i>
                <label for="sizeAo" class="block text-sm font-semibold text-gray-700 mb-2">Size áo</label>
                <select id="sizeAo" name="sizeAo" class="mt-1 block w-full shadow-sm">
                    <option value="">Chọn size áo</option>
                    <optgroup label="Nam">
                        <option value="XXL - Nam (>83kg)">XXL - Nam (>83kg)</option>
                        <option value="XL - Nam (76-83kg)">XL - Nam (76-83kg)</option>
                        <option value="L - Nam (67-75kg)">L - Nam (67-75kg)</option>
                        <option value="M - Nam (59-66kg)">M - Nam (59-66kg)</option>
                        <option value="S - Nam (50-58kg)">S - Nam (50-58kg)</option>
                    </optgroup>
                    <optgroup label="Nữ">
                        <option value="XXL - Nữ (69-75kg)">XXL - Nữ (69-75kg)</option>
                        <option value="XL - Nữ (61-68kg)">XL - Nữ (61-68kg)</option>
                        <option value="L - Nữ (54-60kg)">L - Nữ (54-60kg)</option>
                        <option value="M - Nữ (47-53kg)">M - Nữ (47-53kg)</option>
                        <option value="S - Nữ (40-46kg)">S - Nữ (40-46kg)</option>
                    </optgroup>
                </select>
            </div>

            <!-- Hội viên DNT HCM (MỚI THÊM) -->
            <div class="relative">
                <label class="block text-sm font-semibold text-gray-700 mb-2 required-field">
                    <i data-lucide="user-check" class="inline-block mr-2" style="width: 18px; height: 18px;"></i>
                    Bạn là Hội viên DNT HCM (mới)?
                </label>
                <div class="radio-container">
                    <div class="radio-option" id="radio-yes">
                        <input type="radio" id="hoiVienYes" name="laHoiVien" value="Đúng" required>
                        <label for="hoiVienYes">Đúng</label>
                    </div>
                    <div class="radio-option" id="radio-no">
                        <input type="radio" id="hoiVienNo" name="laHoiVien" value="Không" required>
                        <label for="hoiVienNo">Không</label>
                    </div>
                </div>
            </div>

            <!-- Công ty -->
            <div class="relative">
                <i data-lucide="briefcase" class="input-icon"></i>
                <label for="congTy" class="block text-sm font-semibold text-gray-700 mb-2 required-field">Công ty</label>
                <input type="text" id="congTy" name="congTy"
                    class="input-with-icon mt-1 block w-full shadow-sm h-12 py-2"
                    placeholder="Nhập tên công ty"
                    required>
            </div>

            <!-- Logo công ty -->
            <div class="relative">
                <label for="filelogo" class="block text-sm font-semibold text-gray-700 mb-2">Logo công ty</label>
                <input type="file" id="filelogo" name="filelogo" accept="image/*"
                    class="custom-file-input mt-1 block w-full text-sm text-gray-500">
                <div id="logoPreview" class="mt-4 text-center">
                    <!-- Khu vực để hiển thị xem trước ảnh -->
                </div>
            </div>

            <!-- Chức vụ -->
            <div class="relative">
                <i data-lucide="user-check" class="input-icon"></i>
                <label for="chucVu" class="block text-sm font-semibold text-gray-700 mb-2">Chức vụ (Công ty)</label>
                <input type="text" id="chucVu" name="chucVu"
                    class="input-with-icon mt-1 block w-full shadow-sm h-12 py-2"
                    placeholder="VD: Giám đốc, Trưởng phòng...">
            </div>

            <!-- Sản phẩm/dịch vụ -->
            <div class="relative">
                <i data-lucide="package" class="input-icon"></i>
                <label for="spChudao" class="block text-sm font-semibold text-gray-700 mb-2">Sản phẩm/dịch vụ kinh doanh</label>
                <textarea id="spChudao" name="spChudao" rows="3"
                    class="input-with-icon mt-1 block w-full shadow-sm py-2"
                    placeholder="Mô tả sản phẩm/dịch vụ chủ đạo của công ty"></textarea>
            </div>

            <div class="fixed-button">
                <button type="submit"
                    class="submit-btn w-full flex justify-center items-center py-3 px-6 border border-transparent rounded-xl shadow-lg text-base font-semibold text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                    <i data-lucide="send" class="mr-2" style="width: 20px; height: 20px;"></i>
                    Gửi đăng ký
                </button>
            </div>
        </form>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        // Constants for AppSheet API
        const appId = 'd9ee17ac-4397-452d-9e74-97997607fa4b';
        const accessKey = 'V2-Rovhm-ZiLxx-msd7k-TSoig-NkECL-5LXEq-Kraws-yE09V';
        const region = 'www';

        function apiRequest(tableName, action, data) {
            const apiUrl = `https://${region}.appsheet.com/api/v2/apps/${appId}/tables/${tableName}/Action`;
            return $.ajax({
                url: apiUrl,
                method: 'POST',
                headers: {
                    'ApplicationAccessKey': accessKey,
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify({
                    Action: action,
                    Properties: {
                        Locale: 'vi-VN',
                        Timezone: 'Asia/Ho_Chi_Minh'
                    },
                    ...data
                })
            }).then(response => {
                return response;
            }).catch(error => {
                throw error;
            });
        }

        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        document.getElementById('fileHS').addEventListener('change', async function (event) {
            const file = event.target.files[0];

            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const preview = document.getElementById('imagePreview');
                    preview.innerHTML = `
                        <div class="image-preview-container">
                            <img src="${e.target.result}" alt="Hình hội viên" class="w-40 h-40 rounded-2xl mx-auto border-4 border-indigo-200 object-cover">
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
            } else {
                document.getElementById('imagePreview').innerHTML = '';
            }
        });

        document.getElementById('filelogo').addEventListener('change', async function (event) {
            const file = event.target.files[0];

            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const preview = document.getElementById('logoPreview');
                    preview.innerHTML = `
                        <div class="image-preview-container">
                            <img src="${e.target.result}" alt="Logo công ty" class="w-40 h-40 rounded-2xl mx-auto border-4 border-indigo-200 object-cover">
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
            } else {
                document.getElementById('logoPreview').innerHTML = '';
            }
        });

        document.addEventListener('DOMContentLoaded', function () {
            lucide.createIcons();

            // Khởi tạo Choices.js cho select Size áo
            const sizeAoSelect = new Choices('#sizeAo', {
                searchEnabled: true,
                searchPlaceholderValue: 'Tìm kiếm size...',
                noResultsText: 'Không tìm thấy',
                itemSelectText: 'Nhấn để chọn',
                placeholder: true,
                placeholderValue: 'Chọn size áo phù hợp'
            });

            // Xử lý hiệu ứng cho radio button
            const radioYes = document.getElementById('radio-yes');
            const radioNo = document.getElementById('radio-no');
            const radioInputYes = document.getElementById('hoiVienYes');
            const radioInputNo = document.getElementById('hoiVienNo');

            radioYes.addEventListener('click', function() {
                radioInputYes.checked = true;
                radioYes.classList.add('selected');
                radioNo.classList.remove('selected');
            });

            radioNo.addEventListener('click', function() {
                radioInputNo.checked = true;
                radioNo.classList.add('selected');
                radioYes.classList.remove('selected');
            });

            // Xử lý khi radio button thay đổi
            radioInputYes.addEventListener('change', function() {
                if(this.checked) {
                    radioYes.classList.add('selected');
                    radioNo.classList.remove('selected');
                }
            });

            radioInputNo.addEventListener('change', function() {
                if(this.checked) {
                    radioNo.classList.add('selected');
                    radioYes.classList.remove('selected');
                }
            });

            document.getElementById('expenseForm').addEventListener('submit', async function (e) {
                e.preventDefault();

                // Kiểm tra các trường bắt buộc
                const requiredFields = [
                    { id: 'hoVaTen', name: 'Họ và tên' },
                    { id: 'soDienThoai', name: 'Số điện thoại' },
                    { id: 'email', name: 'Email' },
                    { id: 'congTy', name: 'Công ty' }
                ];

                const missingFields = [];

                requiredFields.forEach(field => {
                    const input = document.getElementById(field.id);
                    if (!input.value.trim()) {
                        missingFields.push(field.name);
                    }
                });

                // Kiểm tra file avatar
                const fileInput = document.getElementById('fileHS');
                if (fileInput.files.length === 0) {
                    missingFields.push('Hình hội viên');
                }

                // Kiểm tra radio button hội viên
                const laHoiVien = document.querySelector('input[name="laHoiVien"]:checked');
                if (!laHoiVien) {
                    missingFields.push('Hội viên DNT HCM');
                }

                if (missingFields.length > 0) {
                    Toastify({
                        text: `⚠️ Vui lòng nhập đầy đủ thông tin: ${missingFields.join(', ')}`,
                        duration: 5000,
                        close: true,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)",
                    }).showToast();
                    return;
                }

                // Thu thập dữ liệu form
                const formData = new FormData(this);
                const data = Object.fromEntries(formData.entries());

                // Đọc hình hội viên
                let filebase = "";
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    filebase = await readFile(file);
                }

                // Đọc logo công ty
                const fileInput1 = document.getElementById('filelogo');
                let logoBase64 = "";
                if (fileInput1.files.length > 0) {
                    const file = fileInput1.files[0];
                    logoBase64 = await readFile(file);
                }

                const formDataToSend = {
                    "Tên hội viên": data.hoVaTen,
                    "Điện thoại hội viên": data.soDienThoai,
                    "Email": data.email,
                    "Ngày sinh nhật": data.ngaySinh,
                    "Giới tính": data.gioiTinh,
                    "Nơi ở hiện tại": data.diaChi,
                    "Trình PKB": data.trinhPKB,
                    "Size áo": data.sizeAo,
                    "Là hội viên": data.laHoiVien, // Thêm trường mới
                    "Công ty": data.congTy,
                    "Chức vụ (Cty)": data.chucVu,
                    "SP/DV_chu_dao": data.spChudao,
                    "Hình hội viên": filebase,
                    "Logo": logoBase64
                };

                console.log(formDataToSend);
                disableForm();
                showLoadingOverlay();

                try {
                    const response = await apiRequest('HV_NCC_KH', 'Add', {
                        Rows: [formDataToSend]
                    });

                    Toastify({
                        text: "✅ Đăng ký thành công! Cảm ơn bạn đã tham gia CLB.",
                        duration: 4000,
                        close: true,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
                    }).showToast();

                    this.reset();
                    document.getElementById('imagePreview').innerHTML = '';
                    document.getElementById('logoPreview').innerHTML = '';
                    radioYes.classList.remove('selected');
                    radioNo.classList.remove('selected');
                    sizeAoSelect.setChoiceByValue(''); // Reset Choices.js select
                } catch (error) {
                    Toastify({
                        text: "❌ Có lỗi xảy ra. Vui lòng thử lại!",
                        duration: 4000,
                        close: true,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)",
                    }).showToast();
                    console.error(error);
                } finally {
                    enableForm();
                    hideLoadingOverlay();
                }
            });
        });

        function disableForm() {
            const form = document.getElementById('expenseForm');
            const elements = form.elements;
            for (let i = 0; i < elements.length; i++) {
                elements[i].disabled = true;
            }
        }

        function enableForm() {
            const form = document.getElementById('expenseForm');
            const elements = form.elements;
            for (let i = 0; i < elements.length; i++) {
                elements[i].disabled = false;
            }
        }

        function showLoadingOverlay() {
            const overlay = document.createElement('div');
            overlay.id = 'loadingOverlay';
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            overlay.style.display = 'flex';
            overlay.style.justifyContent = 'center';
            overlay.style.alignItems = 'center';
            overlay.style.zIndex = '9999';
            overlay.style.flexDirection = 'column';

            const spinner = document.createElement('div');
            spinner.style.border = '6px solid #f3f3f3';
            spinner.style.borderTop = '6px solid #667eea';
            spinner.style.borderRadius = '50%';
            spinner.style.width = '60px';
            spinner.style.height = '60px';
            spinner.style.animation = 'spin 1s linear infinite';

            const text = document.createElement('p');
            text.textContent = 'Đang xử lý...';
            text.style.color = 'white';
            text.style.marginTop = '20px';
            text.style.fontSize = '16px';
            text.style.fontWeight = '600';

            const keyframes = document.createElement('style');
            keyframes.textContent = `
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            `;

            document.head.appendChild(keyframes);
            overlay.appendChild(spinner);
            overlay.appendChild(text);
            document.body.appendChild(overlay);
        }

        function hideLoadingOverlay() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.remove();
            }
        }
    </script>
</body>

</html>
