<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link
    href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Open+Sans:wght@400;600&display=swap"
    rel="stylesheet">
  <link
    href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Dancing+Script:wght@700&display=swap"
    rel="stylesheet">
  <title>Happy Birthday</title>
  <style>
    body {
      font-family: 'Open Sans', sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background-color: #f4f4f4;
    }

    .container {
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      width: 100%;
      height: 100%;
      max-width: 900px;
      height: 600px;
      overflow: hidden;
      background: url('https://rndwows.github.io/CLB_PICKLEBALL_DNT_BD/anhnenbg.jpg') no-repeat center center;
      background-size: contain;
      position: relative;
    }

    .card {
      display: flex;
      flex-direction: row;
      justify-content: center;
      width: 90%;
      height: 100%;
    }

    .left {
      padding: 30px;
      margin: 10px;
      width: 48%;
      box-sizing: border-box;
    }

    .left {
      color: #ffffff;
      display: flex;
      flex-direction: column;
      text-align: center;
      padding-top: 119px;
      padding-left: 35px;
    }

    .left img {
      width: 200px;
      height: 200px;
      border-radius: 50%;
      /* Tạo hình tròn */
      border: 3px solid #FFFFFF;
      /* Viền trong màu vàng */
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.8),
        /* Viền trắng sáng bên ngoài */
        0 0 10px 5px rgba(255, 224, 224, 0.5);
      /* Hiệu ứng phát sáng */
      margin-bottom: 20px;
      object-fit: cover;
      /* Đảm bảo hình ảnh được cắt đúng tỷ lệ */
      object-position: center;
      /* Định vị vùng cắt ở giữa ảnh */
    }


    .name {
      font-size: 40px;
      font-family: 'Montserrat', sans-serif;
      font-weight: 700;
      color: #FFC107;
      /* Hiệu ứng phát sáng */
      margin-bottom: 60px;
      text-align: center;
      background: linear-gradient(to bottom, #FFD700, #FFA500);
      /* Hiệu ứng gradient */
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      -webkit-text-stroke: 1px #8B4513;
      /* Bóng đổ */
      padding: 10px 0;
    }
    .right {
      width: 50%;
      box-sizing: border-box;
    }

    .right {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #ffffff;
    }

    .right p {
      color: #FFD700;
      font-family: 'Open Sans', sans-serif;
      font-weight: 400;
      font-size: 17px;
      line-height: 1.8;
      text-align: center;
    }

    .footer {
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding-bottom: 20px;
      color: #ffffff;
    }

    .pickleball-effect {
      position: absolute;
      width: 50px;
      height: 50px;
      background: url('pickleball.png') no-repeat;
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.7);
      border-radius: 50%;
      transform: perspective(500px) rotateY(20deg);
    }

    .sparkle {
      position: absolute;
      width: 10px;
      height: 10px;
      background: radial-gradient(circle, rgba(255, 255, 255, 1) 0%, rgba(255, 255, 255, 0) 70%);
      animation: sparkle 2s infinite;
    }

    @keyframes sparkle {
      0% {
        opacity: 0;
      }

      50% {
        opacity: 1;
      }

      100% {
        opacity: 0;
      }
    }

    #loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 24px;
      z-index: 1000;
    }

    #error-container {
      position: fixed;
      bottom: 10px;
      left: 10px;
      padding: 10px;
      background-color: rgba(255, 0, 0, 0.7);
      color: white;
      border-radius: 5px;
      font-size: 12px;
      max-width: 80%;
      z-index: 1000;
      display: none;
    }

    @media (min-width: 768px) {
      .left img {
        width: 300px;
        height: 300px;
        border: 4px solid #FFFFFF;
        box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.8),
          0 0 15px 8px rgba(255, 255, 255, 0.5);
      }

      .birthday-title {
        font-size: 40px;
      }

      .name {
        font-size: 30px;
      }
    }
  </style>
</head>

<body>
  <div id="loading">Đang tải dữ liệu...</div>
  <div id="error-container"></div>

  <div class="container" style="display: none; position: relative;">
    <div class="card">
      <div class="left">
        <img id="profile-image" src="default-profile.jpg" alt="Profile Image">
      </div>
      <div class="right">
        <div class="footer">
          <div class="name" id="name"></div>

        </div>
      </div>
    </div>
    <!-- Example pickleball and sparkle effects (adjust positions as needed) -->
    <div class="pickleball-effect" style="top: 50px; left: 50px;"></div>
    <div class="pickleball-effect" style="top: 200px; right: 50px;"></div>
    <div class="sparkle" style="top: 100px; left: 200px;"></div>
    <div class="sparkle" style="top: 300px; right: 150px;"></div>
  </div>

  <button id="capture-btn" style="display: none;">Chụp trang này</button>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    // Constants for AppSheet connection
    const appId = 'd9ee17ac-4397-452d-9e74-97997607fa4b';
    const accessKey = 'V2-Rovhm-ZiLxx-msd7k-TSoig-NkECL-5LXEq-Kraws-yE09V';
    const region = 'www';
    const appName = 'CLBPICKLEBALLDNTBD-903564153-24-10-18';

    // Utility function to show errors
    function showError(message) {
      const errorContainer = document.getElementById('error-container');
      errorContainer.textContent = message;
      errorContainer.style.display = 'block';
      console.error(message);

      setTimeout(() => {
        errorContainer.style.display = 'none';
      }, 10000);
    }

    // Function to convert image name to URL
    function getImageUrl(fileName) {
      if (!fileName) return 'default-profile.jpg';

      const cleanFileName = fileName.trim();
      const baseUrl = 'https://www.appsheet.com/template/gettablefileurl';
      const params = new URLSearchParams({
        appName: appName,
        tableName: 'HV_NCC_KH',
        fileName: cleanFileName
      });

      return `${baseUrl}?${params.toString()}`;
    }

    // Function to convert an image URL to Data URL to avoid CORS issues
    function convertImageToDataURL(imageUrl, callback) {
      const img = new Image();
      img.crossOrigin = "Anonymous"; // Try with this first

      img.onload = function () {
        // Create canvas and convert image to data URL
        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;

        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);

        try {
          // Convert to data URL
          const dataURL = canvas.toDataURL('image/png');
          callback(dataURL);
        } catch (e) {
          console.error("Không thể chuyển đổi hình ảnh sang Data URL", e);
          callback('default-profile.jpg');
        }
      };

      img.onerror = function () {
        console.error("Không thể tải hình ảnh:", imageUrl);
        showError(`Không thể tải hình ảnh từ: ${imageUrl}`);
        callback('default-profile.jpg');
      };

      // Add a random parameter to bypass cache
      img.src = imageUrl + (imageUrl.includes('?') ? '&' : '?') + 'nocache=' + Math.random();

      // If the image fails to load with crossOrigin, try using a proxy
      setTimeout(function () {
        if (!img.complete || img.naturalWidth === 0) {
          console.log("Thử lại với proxy...");
          img.crossOrigin = null;
          // You can add a CORS proxy here if needed
          // img.src = 'https://your-cors-proxy.com/' + encodeURIComponent(imageUrl);
        }
      }, 2000);
    }

    // Function to fetch data from AppSheet
    async function fetchData() {
      try {
        const response = await fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/HV_NCC_KH/Action`, {
          method: 'POST',
          headers: {
            'ApplicationAccessKey': accessKey,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            Action: 'Find',
            Properties: {},
            Selector: "Filter(HV_NCC_KH, true)"
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        if (!Array.isArray(data)) {
          throw new Error('Invalid data format received');
        }

        console.log("Fetched data:", data);
        return data;
      } catch (error) {
        showError(`Lỗi khi tải dữ liệu: ${error.message}`);
        throw error;
      }
    }

    // Function to get URL parameters
    function getUrlParameter(name) {
      name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
      const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
      const results = regex.exec(location.search);
      return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }

    // Initialize the page with data
    async function initialize() {
      try {
        const userId = getUrlParameter('id');

        if (!userId) {
          throw new Error('Không tìm thấy ID người dùng trong URL. Vui lòng thêm tham số ?id=xxx');
        }

        console.log(`Đang tìm người dùng với ID: ${userId}`);

        const allData = await fetchData();
        const userData = allData.find(item => item['Mã'] === userId);

        if (!userData) {
          throw new Error(`Không tìm thấy hội viên với mã: ${userId}`);
        }

        console.log("User data found:", userData);

        // Update the UI with the user data
        document.getElementById('name').textContent = userData['Tên hội viên'] || 'Chưa có tên';

        // Handle the profile image
        if (userData['Hình hội viên']) {
          console.log("Raw image data:", userData['Hình hội viên']);
          const imageUrl = getImageUrl(userData['Hình hội viên']);
          console.log("Processed image URL:", imageUrl);

          // Convert the image URL to data URL to avoid CORS issues
          convertImageToDataURL(imageUrl, function (dataUrl) {
            document.getElementById('profile-image').src = dataUrl;

            // Only show capture button after image is loaded
            document.getElementById('loading').style.display = 'none';
            document.querySelector('.container').style.display = 'flex';
            document.getElementById('capture-btn').style.display = 'block';
          });
        } else {
          document.getElementById('profile-image').src = 'default-profile.jpg';

          // Show content if no image needed
          document.getElementById('loading').style.display = 'none';
          document.querySelector('.container').style.display = 'flex';
          document.getElementById('capture-btn').style.display = 'block';
        }
      } catch (error) {
        console.error('Error during initialization:', error);
        document.getElementById('loading').textContent = `Lỗi: ${error.message}`;
      }
    }

    // Function for test mode
    function testCard(name, imageUrl) {
      document.getElementById('name').textContent = name;

      if (imageUrl) {
        // Convert test image to data URL as well
        convertImageToDataURL(imageUrl, function (dataUrl) {
          document.getElementById('profile-image').src = dataUrl;

          // Show content
          document.getElementById('loading').style.display = 'none';
          document.querySelector('.container').style.display = 'flex';
          document.getElementById('capture-btn').style.display = 'block';
        });
      } else {
        document.getElementById('profile-image').src = 'default-profile.jpg';

        // Show content
        document.getElementById('loading').style.display = 'none';
        document.querySelector('.container').style.display = 'flex';
        document.getElementById('capture-btn').style.display = 'block';
      }
    }

    // Initialize when page loads
    window.addEventListener('DOMContentLoaded', function () {
      // Check for test mode
      const testMode = getUrlParameter('test');
      if (testMode === 'true') {
        const testName = getUrlParameter('name');
        const testImage = getUrlParameter('image') || '';
        testCard(testName, testImage);
      } else {
        initialize();
      }
    });

    // Capture button functionality
    document.getElementById('capture-btn').addEventListener('click', function () {
      html2canvas(document.querySelector('.container'), {
        useCORS: true,
        allowTaint: true,
        logging: true
      }).then(function (canvas) {
        let name = document.getElementById('name').innerText;
        let fileName = name.replace(/\s+/g, '_') + '_HPBD.png';

        let link = document.createElement('a');
        link.download = fileName;
        link.href = canvas.toDataURL('image/png');
        link.click();
      }).catch(function (error) {
        console.error("Lỗi khi chụp hình:", error);
        showError("Không thể chụp hình: " + error.message);
      });
    });
  </script>
</body>

</html>