<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link
    href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Open+Sans:wght@400;600&display=swap"
    rel="stylesheet">
  <link
    href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Dancing+Script:wght@700&display=swap"
    rel="stylesheet">
  <title>Happy Birthday</title>
  <style>
    body {
      font-family: 'Open Sans', sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background-color: #f4f4f4;
    }

    .container {
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      width: 100%;
      height: 100%;
      max-width: 900px;
      height: 600px;
      overflow: hidden;
      background: url('https://rndwows.github.io/CLB_PICKLEBALL_DNT_BD/anhnenbg.jpg') no-repeat center center;
      background-size: contain;
      position: relative;
    }

    .card {
      display: flex;
      flex-direction: row;
      justify-content: center;
      width: 90%;
      height: 100%;
    }

    .left {
      padding: 30px;
      margin: 10px;
      width: 48%;
      box-sizing: border-box;
      color: #ffffff;
      display: flex;
      flex-direction: column;
      text-align: center;
      padding-top: 119px;
      padding-left: 35px;
    }

    .left img {
      width: 200px;
      height: 200px;
      border-radius: 50%;
      border: 3px solid #FFFFFF;
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.8),
        0 0 10px 5px rgba(255, 224, 224, 0.5);
      margin-bottom: 20px;
      object-fit: cover;
      object-position: center;
    }

    .name {
      font-size: 40px;
      font-family: 'Montserrat', sans-serif;
      font-weight: 700;
      color: #FFC107;
      margin-bottom: 60px;
      text-align: center;
      background: linear-gradient(to bottom, #FFD700, #FFA500);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      -webkit-text-stroke: 1px #8B4513;
      padding: 10px 0;
    }

    .right {
      width: 50%;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #ffffff;
    }

    .right p {
      color: #FFD700;
      font-family: 'Open Sans', sans-serif;
      font-weight: 400;
      font-size: 17px;
      line-height: 1.8;
      text-align: center;
    }

    .footer {
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding-bottom: 20px;
      color: #ffffff;
    }

    .pickleball-effect {
      position: absolute;
      width: 50px;
      height: 50px;
      background: url('pickleball.png') no-repeat;
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.7);
      border-radius: 50%;
      transform: perspective(500px) rotateY(20deg);
    }

    .sparkle {
      position: absolute;
      width: 10px;
      height: 10px;
      background: radial-gradient(circle, rgba(255, 255, 255, 1) 0%, rgba(255, 255, 255, 0) 70%);
      animation: sparkle 2s infinite;
    }

    @keyframes sparkle {
      0% { opacity: 0; }
      50% { opacity: 1; }
      100% { opacity: 0; }
    }

    #loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 24px;
      z-index: 1000;
    }

    #error-container {
      position: fixed;
      bottom: 10px;
      left: 10px;
      padding: 10px;
      background-color: rgba(255, 0, 0, 0.7);
      color: white;
      border-radius: 5px;
      font-size: 12px;
      max-width: 80%;
      z-index: 1000;
      display: none;
    }

    #capture-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 24px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      z-index: 999;
    }

    #capture-btn:hover {
      background-color: #45a049;
    }

    @media (min-width: 768px) {
      .left img {
        width: 300px;
        height: 300px;
        border: 4px solid #FFFFFF;
        box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.8),
          0 0 15px 8px rgba(255, 255, 255, 0.5);
      }

      .name {
        font-size: 30px;
      }
    }
  </style>
</head>

<body>
  <div id="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>
  <div id="error-container"></div>

  <div class="container" style="display: none; position: relative;">
    <div class="card">
      <div class="left">
        <img id="profile-image" src="default-profile.jpg" alt="Profile Image">
      </div>
      <div class="right">
        <div class="footer">
          <div class="name" id="name"></div>
        </div>
      </div>
    </div>
    <div class="pickleball-effect" style="top: 50px; left: 50px;"></div>
    <div class="pickleball-effect" style="top: 200px; right: 50px;"></div>
    <div class="sparkle" style="top: 100px; left: 200px;"></div>
    <div class="sparkle" style="top: 300px; right: 150px;"></div>
  </div>

  <button id="capture-btn" style="display: none;">üì∏ Ch·ª•p ·∫£nh thi·ªáp</button>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    const appId = 'd9ee17ac-4397-452d-9e74-97997607fa4b';
    const accessKey = 'V2-Rovhm-ZiLxx-msd7k-TSoig-NkECL-5LXEq-Kraws-yE09V';
    const region = 'www';
    const appName = 'CLBPICKLEBALLDNTBD-903564153-24-10-18';

    let backgroundDataUrl = null;

    function showError(message) {
      const errorContainer = document.getElementById('error-container');
      errorContainer.textContent = message;
      errorContainer.style.display = 'block';
      console.error(message);
      setTimeout(() => {
        errorContainer.style.display = 'none';
      }, 10000);
    }

    function getImageUrl(fileName) {
      if (!fileName) return 'default-profile.jpg';
      const cleanFileName = fileName.trim();
      const baseUrl = 'https://www.appsheet.com/template/gettablefileurl';
      const params = new URLSearchParams({
        appName: appName,
        tableName: 'HV_NCC_KH',
        fileName: cleanFileName
      });
      return `${baseUrl}?${params.toString()}`;
    }

    function convertImageToDataURL(imageUrl, callback) {
      const img = new Image();
      img.crossOrigin = "Anonymous";

      img.onload = function () {
        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        try {
          const dataURL = canvas.toDataURL('image/png');
          callback(dataURL);
        } catch (e) {
          console.error("Kh√¥ng th·ªÉ chuy·ªÉn ƒë·ªïi h√¨nh ·∫£nh sang Data URL", e);
          callback('default-profile.jpg');
        }
      };

      img.onerror = function () {
        console.error("Kh√¥ng th·ªÉ t·∫£i h√¨nh ·∫£nh:", imageUrl);
        showError(`Kh√¥ng th·ªÉ t·∫£i h√¨nh ·∫£nh t·ª´: ${imageUrl}`);
        callback('default-profile.jpg');
      };

      img.src = imageUrl + (imageUrl.includes('?') ? '&' : '?') + 'nocache=' + Math.random();
    }

    function loadBackgroundImage(callback) {
      const bgUrl = 'https://rndwows.github.io/CLB_PICKLEBALL_DNT_BD/anhnenbg.jpg';
      convertImageToDataURL(bgUrl, function(dataUrl) {
        backgroundDataUrl = dataUrl;
        callback();
      });
    }

    function ensureFontsLoaded(callback) {
      if (document.fonts && document.fonts.ready) {
        document.fonts.ready.then(callback);
      } else {
        setTimeout(callback, 1000);
      }
    }

    async function fetchData() {
      try {
        const response = await fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/HV_NCC_KH/Action`, {
          method: 'POST',
          headers: {
            'ApplicationAccessKey': accessKey,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            Action: 'Find',
            Properties: {},
            Selector: "Filter(HV_NCC_KH, true)"
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        if (!Array.isArray(data)) {
          throw new Error('Invalid data format received');
        }

        console.log("Fetched data:", data);
        return data;
      } catch (error) {
        showError(`L·ªói khi t·∫£i d·ªØ li·ªáu: ${error.message}`);
        throw error;
      }
    }

    function getUrlParameter(name) {
      name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
      const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
      const results = regex.exec(location.search);
      return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }

    async function initialize() {
      try {
        const userId = getUrlParameter('id');

        if (!userId) {
          throw new Error('Kh√¥ng t√¨m th·∫•y ID ng∆∞·ªùi d√πng trong URL. Vui l√≤ng th√™m tham s·ªë ?id=xxx');
        }

        console.log(`ƒêang t√¨m ng∆∞·ªùi d√πng v·ªõi ID: ${userId}`);

        const allData = await fetchData();
        const userData = allData.find(item => item['M√£'] === userId);

        if (!userData) {
          throw new Error(`Kh√¥ng t√¨m th·∫•y h·ªôi vi√™n v·ªõi m√£: ${userId}`);
        }

        console.log("User data found:", userData);
        document.getElementById('name').textContent = userData['T√™n h·ªôi vi√™n'] || 'Ch∆∞a c√≥ t√™n';

        loadBackgroundImage(function() {
          if (userData['H√¨nh h·ªôi vi√™n']) {
            console.log("Raw image data:", userData['H√¨nh h·ªôi vi√™n']);
            const imageUrl = getImageUrl(userData['H√¨nh h·ªôi vi√™n']);
            console.log("Processed image URL:", imageUrl);

            convertImageToDataURL(imageUrl, function (dataUrl) {
              document.getElementById('profile-image').src = dataUrl;
              ensureFontsLoaded(function() {
                document.getElementById('loading').style.display = 'none';
                document.querySelector('.container').style.display = 'flex';
                document.getElementById('capture-btn').style.display = 'block';
              });
            });
          } else {
            document.getElementById('profile-image').src = 'default-profile.jpg';
            ensureFontsLoaded(function() {
              document.getElementById('loading').style.display = 'none';
              document.querySelector('.container').style.display = 'flex';
              document.getElementById('capture-btn').style.display = 'block';
            });
          }
        });
      } catch (error) {
        console.error('Error during initialization:', error);
        document.getElementById('loading').textContent = `L·ªói: ${error.message}`;
      }
    }

    function testCard(name, imageUrl) {
      document.getElementById('name').textContent = name;

      loadBackgroundImage(function() {
        if (imageUrl) {
          convertImageToDataURL(imageUrl, function (dataUrl) {
            document.getElementById('profile-image').src = dataUrl;
            ensureFontsLoaded(function() {
              document.getElementById('loading').style.display = 'none';
              document.querySelector('.container').style.display = 'flex';
              document.getElementById('capture-btn').style.display = 'block';
            });
          });
        } else {
          document.getElementById('profile-image').src = 'default-profile.jpg';
          ensureFontsLoaded(function() {
            document.getElementById('loading').style.display = 'none';
            document.querySelector('.container').style.display = 'flex';
            document.getElementById('capture-btn').style.display = 'block';
          });
        }
      });
    }

    window.addEventListener('DOMContentLoaded', function () {
      const testMode = getUrlParameter('test');
      if (testMode === 'true') {
        const testName = getUrlParameter('name');
        const testImage = getUrlParameter('image') || '';
        testCard(testName, testImage);
      } else {
        initialize();
      }
    });

    // ‚ú® Ph·∫ßn ch·ª•p ·∫£nh ƒë√£ ƒë∆∞·ª£c c·∫£i ti·∫øn ‚ú®
    document.getElementById('capture-btn').addEventListener('click', async function () {
      const captureBtn = document.getElementById('capture-btn');
      const container = document.querySelector('.container');
      
      captureBtn.style.display = 'none';
      
      const loadingMsg = document.createElement('div');
      loadingMsg.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 20px; border-radius: 10px; z-index: 10000; font-size: 18px;';
      loadingMsg.textContent = 'ƒêang ch·ª•p ·∫£nh...';
      document.body.appendChild(loadingMsg);

      try {
        // Apply background as data URL
        if (backgroundDataUrl) {
          container.style.backgroundImage = `url(${backgroundDataUrl})`;
        }

        await new Promise(resolve => setTimeout(resolve, 300));

        const canvas = await html2canvas(container, {
          useCORS: true,
          allowTaint: false,
          logging: false,
          scale: 2,
          backgroundColor: '#f4f4f4',
          width: container.offsetWidth,
          height: container.offsetHeight,
          windowWidth: container.offsetWidth,
          windowHeight: container.offsetHeight,
          imageTimeout: 0,
          removeContainer: false
        });

        let name = document.getElementById('name').innerText;
        let fileName = name.replace(/\s+/g, '_') + '_HPBD.png';

        const link = document.createElement('a');
        link.download = fileName;
        link.href = canvas.toDataURL('image/png', 1.0);
        link.click();

        loadingMsg.textContent = '‚úì ƒê√£ l∆∞u ·∫£nh th√†nh c√¥ng!';
        loadingMsg.style.backgroundColor = 'rgba(76, 175, 80, 0.9)';
        
      } catch (error) {
        console.error("L·ªói khi ch·ª•p h√¨nh:", error);
        loadingMsg.textContent = '‚úó L·ªói khi ch·ª•p ·∫£nh!';
        loadingMsg.style.backgroundColor = 'rgba(244, 67, 54, 0.9)';
        showError("Kh√¥ng th·ªÉ ch·ª•p h√¨nh: " + error.message);
      }

      setTimeout(function() {
        document.body.removeChild(loadingMsg);
        captureBtn.style.display = 'block';
      }, 2000);
    });
  </script>
</body>

</html>